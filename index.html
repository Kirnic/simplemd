<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta charset="UTF-8">

        <title>Просмотр товара</title>

        <style type="text/css">
            #myView2--idVBox > div {
                width: 100%;
            }
        </style>

        <script
            id="sap-ui-bootstrap"
            type="text/javascript"
            src="https://sapui5.hana.ondemand.com/sdk/resources/sap-ui-core.js"
            data-sap-ui-theme="sap_belize"
            data-sap-ui-libs="sap.m"
            data-sap-ui-xx-bindingSyntax="complex"
        >
        </script>

        <!-- Страница выбора категории -->
        <script id="view1" type="sapui5/xmlview" >
            <mvc:View
                controllerName="local.controller.Master"
                xmlns="sap.m"
                xmlns:sap.ui.core="sap.ui.core"
                xmlns:mvc="sap.ui.core.mvc" >
                <Page id="page" title="Выбор категории" showFooter="true">
                    <headerContent>
                        <Button icon="sap-icon://cart" tooltip="Добавить в корзину" />
                    </headerContent>
                    <subHeader>
                        <Toolbar id="searchBar" >
                            <content>
                                <SearchField id="searchField" 
                                    width="100%" 
                                    placeholder="Поиск ..." 
                                    showRefreshButton="true" 
                                    search="onSearch"/>
                            </content>
                        </Toolbar>
                    </subHeader>
                    <content>
                        <List id="categoryList" noDataText="Нет данных" items="{/categories}">
                            <items>
                                <StandardListItem type="Active" counter="{counter}" title="{title}" press=""/>
                            </items>
                        </List>
                    </content>
                    <footer>
                        <Toolbar>
                            <ToolbarSpacer />
                            <Button icon="sap-icon://add" press="onOpenDialog" />
                        </Toolbar>
                    </footer>
                </Page>
            </mvc:View>
        </script>

        <script id="dialogFragment" type="ui5/fragment">
            <core:FragmentDefinition
                xmlns="sap.m"
                xmlns:l="sap.ui.layout"
                xmlns:f="sap.ui.layout.form"
                xmlns:core="sap.ui.core" >
                <Dialog
                    title="Новая категория"
                    >
                    <content>
                        <f:SimpleForm items="{/categories}">
                            <f:content>
                                <Label text="Название категории"/>
                                <Input 
                                    value="{/title}"
                                    id="newCategoryName"/>
                                <Label text="Количество"/>
                                <Input
                                    value="{/counter}" 
                                    id="newCategoryCounter"/>
                            </f:content>
                        </f:SimpleForm>
                    </content>
                    <beginButton>
                        <Button text="Создать" press="onAddCategory"/>
                    </beginButton>
                    <endButton>
                        <Button text="Отмена" press="onCloseDialog"/>
                    </endButton>
                </Dialog>
            </core:FragmentDefinition>
        </script>

        <!-- Детальная страница -->
        <script id="view2" type="sapui5/xmlview">
            <mvc:View
                controllerName="local.controller.Detail"
                xmlns="sap.m"
                xmlns:sap.ui.core="sap.ui.core"
                xmlns:mvc="sap.ui.core.mvc" >
                <Page id="page" navButtonPress="handleNavButtonPress" title="{Name}" showNavButton="{device>/isPhone}">
                    <content>
                        <ObjectHeader title="Laptop Case" number="78.99" numberUnit="EUR" introActive="false" titleActive="false" iconActive="false">
                            <attributes>
                                <ObjectAttribute text="Red point stories" active="false" />
                                <ObjectAttribute text="Laptop Case with many room for pencils and other stationaries" active="false" />
                                <ObjectAttribute text="789g" active="false" />
                            </attributes>
                            <firstStatus>
                                <ObjectStatus text="Доступен" state="Success" />
                            </firstStatus>
                        </ObjectHeader>
                        <VBox id="idVBox" direction="Column" alignItems="Center">
                            <items>
                                <IconTabBar
                                    select="onSelectionTab"
                                    expanded="true"
                                    width="100%"
                                    id="idIconTabBar"
                                    class="sapUiResponsiveContentPadding">
                                    <items>
                                      <IconTabFilter
                                        icon="sap-icon://begin"
                                        iconColor="Positive"
                                        design="Horizontal"
                                        count="7 из 14"
                                        text="Confirm Ok"
                                        key="Ok" />
                                      <IconTabSeparator icon="sap-icon://open-command-field" />
                                      <IconTabFilter
                                        icon="sap-icon://compare"
                                        iconColor="Critical"
                                        design="Horizontal"
                                        count="5 из 14"
                                        text="Check Heavys"
                                        key="Heavy" />
                                      <IconTabSeparator icon="sap-icon://open-command-field" />
                                      <IconTabFilter
                                        icon="sap-icon://inventory"
                                        iconColor="Negative"
                                        design="Horizontal"
                                        count="2 из 14"
                                        text="Claim Overweights"
                                        key="Overweight" />
                                    </items>
                                    <content>
                                        <List 
                                            items="{
                                                path: '/goods',
                                                sorter : {
                                                    path : 'price' 
                                                }
                                            }"
                                            noDataText="Нет товаров"
                                            id="goodsList"
                                            >
                                            <headerToolbar>
                                              <Toolbar>
                                                <Title text="Продукты" level="H2" />
                                                <ToolbarSpacer />
                                                <Button
                                                  icon="sap-icon://settings"
                                                  press="handleButtonPress" />
                                                <Button
                                                  icon="sap-icon://person-placeholder"
                                                  press="handleButtonPress" />
                                                <Button
                                                  icon="sap-icon://drop-down-list"
                                                  press="handleButtonPress" />
                                              </Toolbar>
                                            </headerToolbar>
                                            <infoToolbar>
                                              <Toolbar
                                                active="true"
                                                press="handleInfobarPress" >
                                                <Label text="This is the info bar" />
                                              </Toolbar>
                                            </infoToolbar>
                                            <items>
                                                <StandardListItem
                                                    title = "{title}"
                                                    description = "{description}"
                                                    icon = "{icon}"
                                                    iconDensityAware="false"
                                                    iconInset="false"
                                                    info = "{price} {currency}" />
                                            </items>
                                        </List>
                                    </content>
                                </IconTabBar>
                            </items>
                        </VBox>
                    </content>
                    <footer>
                        <Toolbar>
                            <content>
                                <ToolbarSpacer />
                                <Button text="Добавить в корзину" icon="sap-icon://add" />
                            </content>
                        </Toolbar>
                    </footer>
                </Page>
            </mvc:View>
        </script>

        <script>
            var oModel = new sap.ui.model.json.JSONModel("data.json");
            sap.ui.getCore().setModel(oModel);

            sap.ui.controller("local.controller.Master", {
                onOpenDialog: function() {
                    if (!this._oDialog) {
                        this._oDialog = sap.ui.xmlfragment({fragmentContent: jQuery('#dialogFragment').html()}, this);
                        this.getView().addDependent(this._oDialog);
                    }
                    this._oDialog.open();
                },

                onCloseDialog: function() {
                    oModel.setProperty('/title', '');
                    oModel.setProperty('/counter', undefined);
                    this._oDialog.close();
                },

                onAddCategory: function() {
                    var categoryName =  oModel.getProperty('/title');
                    var categoryCounter = Number(oModel.getProperty('/counter'));
                    
                    if (categoryName && categoryCounter > 0) {
                        this._save(categoryName, categoryCounter);
                    } else {
                        oModel.setProperty('/title', '');
                        oModel.setProperty('/counter', undefined);
                        sap.m.MessageToast.show("Некорректные данные. Попробуйте ещё раз");
                    }
                },

                onSearch: function(oEvent) {
                    var filters = [];
                    var query = oEvent.getParameter('query');
                    if (query) {
                        var filtered = new sap.ui.model.Filter('title', sap.ui.model.FilterOperator.Contains, query);
                        filters.push(filtered);
                    }
                    var categoryList = this.getView().byId('categoryList');
                    var binding = categoryList.getBinding('items');
                    binding.filter(filters); 
                },

                _save(name, counter) {
                    var categories = oModel.getProperty('/categories');
                    categories.push({
                        "title": name,
                        "counter": counter
                    });
                    this.onCloseDialog();
                }   
            });

            sap.ui.controller("local.controller.Detail", {
                onSelectionTab: function(oEvent) {
                    var categoryList = this.getView().byId('goodsList');
                    var binding = categoryList.getBinding('items');
                    var sorter = oEvent.getParameter('key');
                    if (sorter === "Ok") {
                        var filter = new sap.ui.model.Filter('price', 'LT', 150);
                        binding.filter(filter);
                    } else if (sorter === "Heavy") {
                        var filter = new sap.ui.model.Filter('price', 'GT', 150);
                        binding.filter(filter);
                    } else if (sorter === "Overweight") {
                        var filter = new sap.ui.model.Filter('price', 'GT', 350);
                        binding.filter(filter);
                    } 
                }
            });

            var splitApp = new sap.m.SplitApp({
                masterPages: [sap.ui.xmlview("myView1", {viewContent:jQuery('#view1').html()})],
                detailPages: [sap.ui.xmlview("myView2", {viewContent:jQuery('#view2').html()})]
            });

            var shell = sap.m.Shell({
                showLogout:false,
                app:splitApp
            });

            shell.placeAt('content');
        </script>

    </head>

    <body class="sapUiBody" role="application">
        <div id="content"></div>
    </body>
</html>
